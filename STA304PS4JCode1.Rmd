---
title: "JCodeAppendix"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load Packages
library(haven)
library(tidyverse)
library(labelled)
library(jtools)
```

```{r}
raw_data <- read_dta("ns20200625.dta")

# Add Labels
raw_data <- labelled::to_factor(raw_data)
```



```{r}
# Select Vars of Interest
select_data <- raw_data %>%
  dplyr::select(vote_2020,
                age,
                gender,
                race_ethnicity,
                census_region,
                language
  )
```

```{r}
# Clean out NAs
clean_data <- select_data %>%
  na.omit() %>%
  filter(vote_2020 %in% c("Joe Biden", "Donald Trump"))
```

```{r}
# Create Groupings for Post-Strat Matching
clean_data <- clean_data %>%
  mutate(age_group = cut(age, 
                         breaks = c(18, 30, 40, 50, 60, 100), 
                         right = FALSE,
                         labels = c("18 to 29", 
                                    "30 to 39", 
                                    "40 to 49", 
                                    "50 to 59",
                                    "60 +")
                         ),
         race_ethnicity = case_when(race_ethnicity == "Black, or African American" ~ "Black, or African American",
                                    race_ethnicity == "White" ~ "White",
                                    race_ethnicity != "Black, or African American" | race_ethnicity != "White" ~ "Other"),
         language = case_when(language == "Yes, we speak Spanish." ~ "Spanish",
                              language == "Yes, we speak a language other than Spanish or English." ~ "Other",
                              language == "No, we speak only English." ~ "English")

           
  )
```


```{r}
# Graph Vote Distribution
clean_data %>% 
  ggplot(aes(x = vote_2020)) + 
  geom_bar() + 
  labs(title = "Vote Decisions of Respondents", 
       x = "Vote Choice",
       y = "Number of Respondents"
       )
prop.table(table(clean_data$vote_2020))
```



```{r}
# Graph Age Distribution
clean_data %>% 
  ggplot(aes(x = age_group)) + 
  geom_bar() +
  labs(title = "Age Proportions of Respondents", 
       x = "Age",
       y = "Number of Respondents"
       )
```


```{r}
# Graph Gender Distribution
clean_data %>% 
  ggplot(aes(x = gender)) + 
  geom_bar() + 
  labs(title = "Gender Proportions of Respondents", 
       x = "Gender",
       y = "Number of Respondents"
       )
prop.table(table(clean_data$gender))
```


```{r}
# Graph Race Distribution
clean_data %>% 
  ggplot(aes(x = race_ethnicity)) + 
  geom_bar() + 
  labs(title = "Races of Respondents", 
       x = "Race",
       y = "Number of Respondents"
       ) + 
  coord_flip()
prop.table(table(clean_data$race_ethnicity))
```



```{r}
# Graph Language Distribution
clean_data %>% 
  ggplot(aes(x = language)) + 
  geom_bar() + 
  labs(title = "Languages Used by Respondents", 
       x = "Language Used at Home",
       y = "Number of Respondents"
       )
prop.table(table(clean_data$language))

```


```{r}
# Graph Regional Distribution
clean_data %>% 
  ggplot(aes(x = census_region)) + 
  geom_bar() + 
  labs(title = "Regional Distribution of Respondents", 
       x = "Vote Choice",
       y = "Number of Respondents"
       )

prop.table(table(clean_data$census_region))
```


```{r}
# Create Regression Model
survey_glm <- glm(as.numeric(vote_2020 == "Donald Trump") ~ 
                    age_group + 
                    gender +
                    census_region + 
                    race_ethnicity + 
                    language,
                  family = 'binomial',
                  data = clean_data
)

summary(survey_glm)
```


POST STRAT DATA

```{r}
# Read Post Strat Data
raw_strat_data <- read_dta("usa_00002.dta")
```

```{r}
# Factor data names and labels
raw_strat_data <- labelled::to_factor(raw_strat_data)
```

```{r}
# Select Data
raw_select_strat_data <- raw_strat_data %>%
  select(age,
         sex,
         race,
         hispan,
         bpl,
         region,
         language,
         empstat
    
  )
```

```{r}
# Reselect and Name Data
clean_strat_data <-
  raw_select_strat_data %>%
  select(region, 
         sex, 
         age, 
         race, 
         bpl, 
         language) %>% 
  rename(gender = sex, 
         race_ethnicity = race, 
         census_region = region,
         foriegn_born = bpl)
```

```{r}
# Factor Data Names
clean_strat_data <- labelled::to_factor(clean_strat_data)
  
```


```{r}
# Creating Matching Groups to Survey Data
clean_strat_data <- clean_strat_data %>%
  mutate(age_group = cut(as.numeric(age), 
                         breaks = c(18, 30, 40, 50, 60, 100), 
                         right = FALSE,
                         labels = c("18 to 29", 
                                    "30 to 39", 
                                    "40 to 49", 
                                    "50 to 59",
                                    "60 +")
                         ),
         census_region = case_when(census_region == "new england division" ~ "Northeast",
                                  census_region == "middle atlantic division" ~ "Northeast",
                                  census_region == "east north central div" ~ "Midwest",
                                  census_region == "west north central div" ~ "Midwest",
                                  census_region == "south atlantic division" ~ "South",
                                  census_region == "east south central div" ~ "South",
                                  census_region == "west south central div" ~ "South",
                                  census_region == "mountain division" ~ "West",
                                  census_region == "pacific division" ~ "West"
                                  ),
         language = case_when(language == "english" ~ "English",
                              language == "spanish" ~ "Spanish",
                              language != "english" | language != "spanish" ~ "Other"
                              ),
         race_ethnicity = case_when(race_ethnicity == "black/african american/negro" ~ "Black, or African American",
                                    race_ethnicity == "white" ~ "White",
                                    race_ethnicity != "black/african american/negro" | race_ethnicity != "white" ~ "Other"
                                    ),
         gender = case_when(gender == "male" ~ "Male",
                            gender == "female" ~ "Female")



         

    
  )
```

```{r}
# Remove Data that doesn't fit the groups
clean_strat_data <- clean_strat_data %>%
  na.omit()
```


```{r}
clean_strat_data %>% 
  ggplot(aes(x = age_group)) + 
  geom_bar() +
  labs(title = "Age Proportions of Respondents", 
       x = "Age",
       y = "Number of Respondents"
       )
prop.table(table(clean_strat_data$age_group))
```



```{r}
clean_strat_data %>% 
  ggplot(aes(x = gender)) + 
  geom_bar() + 
  labs(title = "Gender Proportions of Respondents", 
       x = "Gender",
       y = "Number of Respondents"
       )
prop.table(table(clean_strat_data$gender))
```


```{r}
clean_strat_data %>% 
  ggplot(aes(x = race_ethnicity)) + 
  geom_bar() + 
  labs(title = "Races of Respondents", 
       x = "Race",
       y = "Number of Respondents"
       ) + 
  coord_flip()
prop.table(table(clean_strat_data$race_ethnicity))
```


```{r}
clean_strat_data %>% 
  ggplot(aes(x = language)) + 
  geom_bar() + 
  labs(title = "Languages Used by Respondents", 
       x = "Language Used at Home",
       y = "Number of Respondents"
       )
prop.table(table(clean_strat_data$language))

```



```{r}
clean_strat_data %>% 
  ggplot(aes(x = census_region)) + 
  geom_bar() + 
  labs(title = "Regional Distribution of Respondents", 
       x = "Vote Choice",
       y = "Number of Respondents"
       )
prop.table(table(clean_strat_data$census_region))
```


```{r}
# Create Cells
cell_counts <- clean_strat_data %>% 
  group_by(age_group, gender, census_region, race_ethnicity, language) %>%
  count() %>%
  mutate(proportion = n/2603150
         )

```

```{r,include=FALSE}
# Create Prediction Vector
predictions <- predict.glm(survey_glm, cell_counts, type = "response")
```

```{r}
# Add Predictions to cell counts
cell_counts2 <- cbind(cell_counts, predictions)
```

```{r}
# First Forecasting Result
vote_pred <- cell_counts2$proportion * cell_counts2$...8
sum(vote_pred)
```











































